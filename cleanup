
const { createClient } = require('@supabase/supabase-js')
const bcrypt = require('bcryptjs')
require('dotenv').config({ path: '.env.local' })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl || !supabaseServiceRoleKey) {
  console.error('Missing env vars')
  process.exit(1)
}

const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: { autoRefreshToken: false, persistSession: false }
})

const usersToCreate = [
  {
    email: 'akayeteb@upsamail.edu.gh',
    password: 'Option#4',
    role: 'porter',
    firstName: 'Porter',
    lastName: 'User',
    idPrefix: 'POR'
  },
  {
    email: 'akayetez@upsamail.edu.gh',
    password: 'Option#4',
    role: 'director',
    firstName: 'Director',
    lastName: 'User',
    idPrefix: 'DIR'
  }
]

async function createStaffUsers() {
  for (const userData of usersToCreate) {
    const { email, password, role, firstName, lastName, idPrefix } = userData
    console.log(`\n--- Starting creation process for ${email} (${role}) ---`)

    // 1. Get Role ID
    const { data: roleData, error: roleError } = await supabaseAdmin
      .from('roles')
      .select('id')
      .eq('name', role)
      .single()

    if (roleError) {
      console.error(`Role lookup failed for ${role}:`, roleError)
      continue
    }
    console.log(`Role found:`, roleData)

    // 2. Create Auth User
    let userId;
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
      user_metadata: { role }
    })

    if (authError) {
      if (authError.message.includes('already registered')) {
        console.log('User already registered in Auth. Finding ID...')
        const { data: listData, error: listError } = await supabaseAdmin.auth.admin.listUsers()
        const existingUser = listData?.users.find(u => u.email === email)
        if (!existingUser) {
          console.error('Could not find existing user')
          continue
        }
        userId = existingUser.id
        console.log('Found existing user ID:', userId)
        
        console.log('Updating password...')
        await supabaseAdmin.auth.admin.updateUserById(userId, { password })
      } else {
        console.error('Auth user creation failed:', authError)
        continue
      }
    } else {
      userId = authData.user.id
      console.log('New auth user created:', userId)
    }

    // 3. Sync with public.users
    const hashedPassword = await bcrypt.hash(password, 10)
    const { error: syncError } = await supabaseAdmin
      .from('users')
      .upsert({
        id: userId,
        email,
        password_hash: hashedPassword,
        role_id: roleData.id,
        is_active: true
      }, { onConflict: 'email' })

    if (syncError) {
      console.error('Sync to public.users failed:', syncError)
      continue
    }
    console.log('Synced to public.users.')

    // 4. Create/Update Profile
    const { error: profileError } = await supabaseAdmin
      .from('profiles')
      .upsert({
        user_id: userId,
        first_name: firstName,
        last_name: lastName,
        student_id: `${idPrefix}-${firstName.toUpperCase()}`
      }, { onConflict: 'user_id' })

    if (profileError) {
      console.error('Profile sync failed:', profileError)
      continue
    }
    console.log('Profile synced.')
  }

  console.log('\n--- ALL USERS PROCESSED ---')
}

createStaffUsers()
